<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="kr.or.ddit.startup.design.mapper.DesignMapper">

	<resultMap id="designVoMap" type="kr.or.ddit.startup.design.vo.SuShowDesignVO">
	    <id     property="designId"      column="DESIGN_ID"/>
	    <result property="designName"    column="DESIGN_NAME"/>
	    <result property="createdAt"     column="CREATED_AT"/>
	    <result property="screenshotUrl" column="screenshotUrl"/>
	    <result property="designData"    column="DESIGN_DATA" jdbcType="CLOB" javaType="java.lang.String"/>
	</resultMap>

    <resultMap id="likedPostVoMap" type="kr.or.ddit.startup.design.vo.DesignLikedPostVO">
        <id     property="postId"        column="POST_ID"/>
        <result property="title"         column="TITLE"/>
        <result property="creatorId"     column="creatorId"/>
        <result property="screenshotUrl" column="screenshotUrl"/>
    </resultMap>

	<resultMap id="designDetailMap" type="kr.or.ddit.startup.design.vo.SuShowDesignVO">
	    <id     property="designId"    column="DESIGN_ID"/>
	    <result property="userId"      column="USER_ID"/>
	    <result property="designName"  column="DESIGN_NAME"/>
	    <result property="designData"  column="DESIGN_DATA" jdbcType="CLOB" javaType="java.lang.String"/>
	    <result property="fileGroupNo" column="FILE_GROUP_NO"/>
	</resultMap>

    <resultMap id="showPostVoMap" type="kr.or.ddit.startup.show.vo.SuShowPostVO">
        <id     property="postId"        column="POST_ID"/>
        <result property="userId"        column="USER_ID"/>
        <result property="title"         column="TITLE"/>
        <result property="thumbnailPath" column="thumbnailPath"/>
    </resultMap>
    
    <resultMap id="designDetailWithThumbMap" type="kr.or.ddit.startup.design.vo.SuShowDesignVO" extends="designDetailMap">
        <result property="screenshotUrl" column="screenshotUrl"/>
    </resultMap>


    <insert id="insertDesign" parameterType="kr.or.ddit.startup.design.vo.SuShowDesignVO">
        <selectKey keyProperty="designId" resultType="int" order="BEFORE">
            SELECT SEQ_SU_SHOW_DESIGN_ID.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO SU_SHOW_DESIGN (
            DESIGN_ID, 
            USER_ID, 
            DESIGN_NAME, 
            DESIGN_DATA,
            FILE_GROUP_NO, 
            CREATED_AT, 
            IS_DELETED
        ) VALUES (
            #{designId}, 
            #{userId}, 
            #{designName}, 
            #{designData, jdbcType=CLOB},
            #{fileGroupNo}, 
            SYSDATE, 
            'N'
        )
    </insert>
    
    <!-- JSON , 화면캡처 함께 저장 -->
    <select id="selectDesignWithThumbById" parameterType="int" resultMap="designDetailWithThumbMap">
        SELECT
            D.DESIGN_ID,
            D.USER_ID,
            D.DESIGN_NAME,
            D.DESIGN_DATA,
            D.FILE_GROUP_NO,
            F.FILE_SAVE_LOCATE AS screenshotUrl
        FROM SU_SHOW_DESIGN D
        LEFT JOIN (
            SELECT FILE_GROUP_NO, FILE_SAVE_LOCATE
            FROM (
                SELECT
                    FILE_GROUP_NO,
                    FILE_SAVE_LOCATE,
                    ROW_NUMBER() OVER(PARTITION BY FILE_GROUP_NO ORDER BY FILE_SN ASC) AS RN
                FROM FILE_DETAIL
                WHERE FILE_ROLE = 'thumbnail'
            )
            WHERE RN = 1
        ) F
          ON D.FILE_GROUP_NO = F.FILE_GROUP_NO
        WHERE D.DESIGN_ID = #{designId}
    </select>
    
    <!-- 마이페이지에서의 도면 파일 삭제 -->
    <update id="deleteDesign" parameterType="map">
        UPDATE SU_SHOW_DESIGN
        SET
            IS_DELETED = 'Y'
        WHERE
            DESIGN_ID = #{designId}
            AND USER_ID = #{userId}
    </update>
    
    <!-- 디자인 정보 업데이트 -->
	<update id="updateDesign" parameterType="kr.or.ddit.startup.design.vo.SuShowDesignVO">
	    UPDATE SU_SHOW_DESIGN
	    SET
	        DESIGN_NAME = #{designName},
	        DESIGN_DATA = #{designData, jdbcType=CLOB},
	        FILE_GROUP_NO = #{fileGroupNo}
	    WHERE
	        DESIGN_ID = #{designId}
	        AND USER_ID = #{userId}
	</update>
    
    <!-- 마이페이지에서의 도면 파일 이름 변경 -->
    <update id="renameDesign">
        UPDATE SU_SHOW_DESIGN
        SET
            DESIGN_NAME = #{newDesignName}
        WHERE
            DESIGN_ID = #{designId}
            AND USER_ID = #{userId}
    </update>

    <select id="selectLikedPosts" parameterType="String" resultMap="likedPostVoMap">
        SELECT
            P.POST_ID,
            P.TITLE,
            P.USER_ID AS creatorId,
            F.FILE_SAVE_LOCATE AS screenshotUrl
        FROM
            SU_SHOW_POST P
            INNER JOIN SU_SHOW_POST_LIKE L ON (P.POST_ID = L.POST_ID)
            LEFT OUTER JOIN FILE_DETAIL F ON (P.FILE_GROUP_NO = F.FILE_GROUP_NO AND F.FILE_ROLE = 'thumbnail')
        WHERE
            L.USER_ID = #{userId} AND P.IS_DELETED = 'N'
        ORDER BY
            L.LIKED_AT DESC
    </select>

    <select id="selectDesignById" parameterType="int" resultMap="designDetailMap">
        SELECT
            DESIGN_ID,
            USER_ID,
            DESIGN_NAME,
            DESIGN_DATA,
            FILE_GROUP_NO
        FROM
            SU_SHOW_DESIGN
        WHERE
            DESIGN_ID = #{designId}
    </select>
    
    <!-- 관리자의 디자인 목록 조회 -->
    <select id="selectDesignsByUserId" parameterType="String" resultMap="designVoMap">
	    SELECT
	        D.DESIGN_ID,
	        D.DESIGN_NAME,
	        D.CREATED_AT,
	        F.FILE_SAVE_LOCATE AS screenshotUrl
	    FROM
	        SU_SHOW_DESIGN D
	        LEFT OUTER JOIN FILE_DETAIL F ON (D.FILE_GROUP_NO = F.FILE_GROUP_NO AND F.FILE_ROLE = 'thumbnail')
	    WHERE
	        D.USER_ID = #{userId} AND D.IS_DELETED = 'N'
	    ORDER BY
	        D.CREATED_AT DESC
	</select>

    <select id="selectLatestPosts" resultMap="showPostVoMap">
        SELECT
            B.POST_ID,
            B.TITLE,
            B.USER_ID,
            B.thumbnailPath
        FROM (
            SELECT
                SP.POST_ID,
                SP.TITLE,
                SP.USER_ID,
                F.FILE_SAVE_LOCATE AS thumbnailPath
            FROM
                SU_SHOW_POST SP
                LEFT JOIN (
                    SELECT
                        FILE_GROUP_NO,
                        FILE_SAVE_LOCATE,
                        ROW_NUMBER() OVER(PARTITION BY FILE_GROUP_NO ORDER BY FILE_SN ASC) as file_rn
                    FROM 
                        FILE_DETAIL
                    WHERE 
                        FILE_ROLE = 'thumbnail'
                ) F ON F.FILE_GROUP_NO = SP.FILE_GROUP_NO AND F.file_rn = 1
            WHERE
                SP.IS_DELETED = 'N'
            ORDER BY
                SP.CREATED_AT DESC
        ) B
        WHERE
            ROWNUM &lt;= 7
    </select>
    
	<!-- 특정 사용자가 저장한 디자인의 총 개수 조회 -->
    <select id="selectMyDesignsCount" parameterType="String" resultType="int">
	    SELECT
	        COUNT(DESIGN_ID)
	    FROM
	        SU_SHOW_DESIGN
	    WHERE
	        USER_ID = #{userId} AND IS_DELETED = 'N'
	</select>
	
	<!-- 특정 사용자가 저장한 디자인 목록 조회 (페이징 처리) -->
	<select id="selectMyDesigns" parameterType="map" resultMap="designVoMap">
	    SELECT
	        B.*
	    FROM (
	        SELECT
	            A.*,
	            ROWNUM AS RNUM
	        FROM (
	            SELECT
	                D.DESIGN_ID,
	                D.DESIGN_NAME,
	                D.CREATED_AT,
	                F.FILE_SAVE_LOCATE AS screenshotUrl,
	                D.DESIGN_DATA   
	            FROM
	                SU_SHOW_DESIGN D
	                LEFT OUTER JOIN FILE_DETAIL F ON (D.FILE_GROUP_NO = F.FILE_GROUP_NO AND F.FILE_ROLE = 'thumbnail')
	            WHERE
	                D.USER_ID = #{userId} AND D.IS_DELETED = 'N'
	            ORDER BY
	                D.CREATED_AT DESC
	        ) A
	    ) B
	    WHERE
	        B.RNUM BETWEEN #{startRow} AND #{endRow}
	</select>	
	
	<!-- 페이징 없이 특정 사용자의 모든 디자인 목록 조회 -->
	<select id="selectAllMyDesigns" parameterType="String" resultMap="designVoMap">
	    SELECT
	        D.DESIGN_ID,
	        D.DESIGN_NAME,
	        D.CREATED_AT,
	        F.FILE_SAVE_LOCATE AS screenshotUrl,
	        D.DESIGN_DATA      FROM
	        SU_SHOW_DESIGN D
	        LEFT OUTER JOIN FILE_DETAIL F ON (D.FILE_GROUP_NO = F.FILE_GROUP_NO AND F.FILE_ROLE = 'thumbnail')
	    WHERE
	        D.USER_ID = #{userId} AND D.IS_DELETED = 'N'
	    ORDER BY
	        D.CREATED_AT DESC
	</select>

</mapper>