<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper
	namespace="kr.or.ddit.community.free.mapper.FreeCommentMapper">

	<!-- 댓글 목록 조회 -->
	<select id="selectFreeCommentsByPostId"
		resultType="kr.or.ddit.community.free.vo.CommFreeCommentVO">
		SELECT
		COMMENT_ID, POST_ID, USER_ID, CONTENT,
		CREATED_AT, UPDATED_AT, PARENT_ID, DEPTH, IS_DELETED
		FROM COMM_FREE_COMMENT
		WHERE POST_ID = #{postId}
		AND (IS_DELETED = 'N' OR IS_DELETED IS NULL)
		ORDER BY NVL(PARENT_ID, COMMENT_ID), CREATED_AT ASC
	</select>

	<!-- 댓글 등록 -->
	<insert id="insertComment"
		parameterType="kr.or.ddit.community.free.vo.CommFreeCommentVO">
		<selectKey keyProperty="commentId" resultType="int"
			order="BEFORE">
			SELECT SEQ_COMM_FREE_COMMENT.NEXTVAL FROM DUAL
		</selectKey>
		INSERT INTO COMM_FREE_COMMENT (
		COMMENT_ID, POST_ID, USER_ID, CONTENT, PARENT_ID, DEPTH
		) VALUES (
		#{commentId}, #{postId}, #{userId}, #{content}, #{parentId}, #{depth}
		)
	</insert>

	<!-- 단건 조회 -->
	<select id="selectCommentById"
		resultType="kr.or.ddit.community.free.vo.CommFreeCommentVO">
		SELECT
		COMMENT_ID, POST_ID, USER_ID, CONTENT,
		CREATED_AT, UPDATED_AT, PARENT_ID, DEPTH, IS_DELETED
		FROM COMM_FREE_COMMENT
		WHERE COMMENT_ID = #{commentId}
	</select>

	<!-- 내용 수정 -->
	<update id="updateComment"
		parameterType="kr.or.ddit.community.free.vo.CommFreeCommentVO">
		UPDATE COMM_FREE_COMMENT
		SET
		CONTENT = #{content},
		UPDATED_AT = SYSDATE
		WHERE COMMENT_ID = #{commentId}
	</update>

	<!-- 게시글에 속한 모든 댓글 소프트 삭제 -->
	<update id="deleteCommentsByPostId">
		UPDATE COMM_FREE_COMMENT
		SET IS_DELETED = 'Y',
		CONTENT = '삭제된 댓글입니다.',
		UPDATED_AT = SYSDATE
		WHERE POST_ID = #{postId}
	</update>

	<!-- freeComment-Mapper.xml -->
	<update id="softDeleteFreeComment">
		UPDATE COMM_FREE_COMMENT
		SET IS_DELETED = 'Y',
		CONTENT = '삭제된 댓글입니다.',
		UPDATED_AT = SYSDATE
		WHERE COMMENT_ID = #{commentId}
	</update>
	
	<select id="countCommentsByUserId" parameterType="string" resultType="int">
	    SELECT COUNT(*)
	    FROM COMM_FREE_COMMENT
	    WHERE USER_ID = #{userId} AND IS_DELETED = 'N'
	</select>
	
		<select id="selectCommentsByUserId" parameterType="string" resultType="kr.or.ddit.community.free.vo.CommFreeCommentVO">
	    SELECT 
	        POST_ID, NVL(CONTENT, '') AS CONTENT, CREATED_AT 
	    FROM COMM_FREE_COMMENT
	    WHERE USER_ID = #{userId} AND IS_DELETED = 'N'
	    ORDER BY CREATED_AT DESC
	</select>



</mapper>